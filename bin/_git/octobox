#!/usr/bin/ruby --disable-gems

require 'json'

data = JSON.load(File.read('/tmp/octobox'))

def remove_id(id)
  data = JSON.load(File.read('/tmp/octobox'))
  data.reject! { |f| f['id'] == id }
  File.write('/tmp/octobox', JSON.dump(data))
end

def colour(which, urgent)
  case which
  when 'merged'
    urgent ? 129 : 54
  when 'open'
    urgent ? 34 : 22
  else # 'closed'
    urgent ? 196 : 88
  end
end

PR = "\u{e726}"
ISSUE = "\u{f41b}"
ISSUE_CLOSED = "\u{f41d}"

urgent_reasons = %w(author review_requested mention)

printall=->(){
data.each.with_index do |ntf, index|
  next unless ntf.fetch('unread')
  type = ntf.fetch('subject').fetch('type')
  state = ntf.fetch('subject').fetch('state')

  reason = ntf.fetch('reason')
  urgent = urgent_reasons.include?(reason)

  icon = case type
  when 'Issue'
    state == 'closed' ? ISSUE_CLOSED : ISSUE
  when 'PullRequest'
    PR
  else
    '?'
  end

  c = colour(state, urgent)

  id = ntf.fetch('web_url').split('/').last.sub(/#.*/, '')
  slug = "#{ntf.fetch('repo').fetch('name')}##{id}".sub(/^Shopify/, 'S').sub(/^burke/, 'b')
  title = ntf.fetch('subject').fetch('title')
  puts "#{index}. \x1b[38;5;#{c}m#{icon}\x1b[0m \x1b[3m(#{slug})\x1b[0m :: #{title}"
end
}

open_index = ->(n) {
  web_url = data[n].fetch('web_url')
  id = data[n].fetch('id')
  data.slice!(n)
  remove_id(id)
  system("open", web_url)
}

printall.()

loop do
  print '> '
  $stdout.flush
  case cmd = gets
  when /^o /
    args = cmd.split(' ')
    args.each do |arg|
      index = arg.to_i
      open_index.(arg.to_i)
    end
  when /^p/
    printall.()
  when /^q/
    break
  end
end
