#!/bin/bash
# args: remind <title> <timespec>
set -euo pipefail

if [[ $# -lt 2 ]]; then
  >&2 echo "usage: remind <title> <timespec>"
  exit 1
fi

title=$1; shift

job_id="$(echo "ls" | at "$*" 2>&1 | awk '{print $2}')"
date_from_atq="$(atq | awk '$1 == '${job_id}' { $1 = ""; print}' | sed 's/^ //')"
date_for_apple="$(date -jf "%a %b %d %H:%M:%S %Y" "${date_from_atq}" +"%m/%d/%Y %I:%M:%S %p")"
atrm "${job_id}"

osascript - "${title}" "${date_for_apple}" <<END
on run argv
    set dueDate to date (item 2 of argv)
    tell application "Reminders"
        make new reminder with properties {name:item 1 of argv, due date:dueDate, remind me date:dueDate}
    end tell
end run
END
