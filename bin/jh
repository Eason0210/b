#!/usr/bin/env ruby -n
BEGIN { require 'digest/md5'; require 'json'; trap("INT"){} }

begin
  log_data = JSON.parse($_)

  # The timestamp has millisecond precision
  time = Time.at(log_data.delete('event_timestamp').to_i / 1000)

  # remove fields that humans don't care about
  %w(event_dvc event_app event_id).each{|k| log_data.delete k}

  event_name = log_data.delete("event_name")
  log_level  = log_data.delete("log_level")

  color, reset = case log_level
          when "CRITICAL", "ERROR" then ["\x1b[31m", "\x1b[0m"]
          when "WARN" then ["\x1b[33m", "\x1b[0m"]
          when "DEBUG" then ["\x1b[37m", "\x1b[0m"]
          else ["", ""]
          end

  if txn = log_data.delete('transaction_id')
    txc = Digest::MD5.hexdigest(txn)[0..1].to_i(16)
    transaction = "\x1b[38;5;#{txc}m#{txn[0..3]}#{color.empty? ? "\x1b[0m" : color}"
  else
    transaction = "----"
  end

  more_info = log_data.keys.sort.map { |k| "#{k}=#{log_data[k]}" }.join(' | ')

  puts "#{color}%s | %26s | %8s | %s | %s#{reset}" % [time, event_name, log_level, transaction, more_info]
rescue Exception
  puts "\x1b[31m<line humanization failed: #$_.chomp>\x1b[0m"
end
