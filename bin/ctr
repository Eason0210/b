#!/bin/bash

ctags=$(which ctags)
bundle=/opt/boxen/rbenv/shims/bundle
gem_home=~/opt/boxen/rbenv/versions/$(cat /opt/boxen/rbenv/version)/lib/ruby/gems/1.9.1

# end config

function ensurelink() {
  to=$1
  link=$2

  if [ -e $link ] ; then
    if [[ $(readlink $link) != "$to" ]] ; then
      echo "Resetting link to $to"
      rm $to
      ln -s $to $link
    fi
  else
    echo "Setting up link to $to"
    ln -s $to $link
  fi
}


mkdir -p ~/.s
ensurelink $gem_home/gems ~/.s/g
ensurelink $gem_home/bundler/gems ~/.s/b

gem_sources=$(
  export PATH="$HOME/.rbenv/bin:$PATH"
  $bundle list --paths |\
    sed "s|$gem_home/gems|$HOME/.s/g|" |\
    sed "s|$gem_home/bundler/gems|$HOME/.s/b|"
)

$ctags -R --languages=ruby . $gem_sources

